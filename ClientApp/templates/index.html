<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Controller</title>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f0f2f5; }
        
        /* Layout chia ƒë√¥i */
        .main-panel { flex: 7; padding: 20px; overflow-y: auto; }
        .side-panel { flex: 3; background: #fff; border-left: 1px solid #ccc; display: flex; flex-direction: column; padding: 10px; }

        /* B·∫£ng danh s√°ch App */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; }
        tr:hover { background-color: #f1f1f1; cursor: pointer; }
        tr.selected { background-color: #cce5ff; }

        /* C√°c n√∫t ch·ª©c nƒÉng */
        .controls { display: flex; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex: 1; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .btn-list { background-color: #17a2b8; }
        .btn-stop { background-color: #dc3545; }
        .btn-start { background-color: #28a745; }
        button:hover { opacity: 0.9; }

        /* Chat log b√™n ph·∫£i */
        #chat-log { flex: 1; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; padding: 5px; font-size: 12px; font-family: monospace; background: #fafafa; }
        .log-line { margin-bottom: 4px; padding: 4px; border-bottom: 1px solid #eee; }
        .status-ok { color: green; font-weight: bold; }
        .status-err { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="main-panel">
        <h2>üöÄ B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng</h2>
        
        <div class="controls">
            <button class="btn-list" onclick="sendCmd('listApps')">üîÑ L√†m m·ªõi danh s√°ch</button>
        </div>
        <br>
        <div class="controls">
            <input type="text" id="appName" placeholder="Nh·∫≠p t√™n App (VD: notepad)...">
            <button class="btn-stop" onclick="stopApp()">üõë D·ª´ng App</button>
            <button class="btn-start" onclick="startApp()">‚ñ∂ Kh·ªüi ƒë·ªông App</button>
        </div>

        <h3>Danh s√°ch ·ª©ng d·ª•ng ƒëang ch·∫°y (<span id="appCount">0</span>)</h3>
        <table id="appTable">
        <thead>
            <tr>
                <th width="80">PID</th>
                <th>Ti√™u ƒë·ªÅ c·ª≠a s·ªï (Window Title)</th> <th width="150">T√™n File (EXE)</th>
                <th width="100">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    </div>

    <div class="side-panel">
        <h4>üì° Log K·∫øt N·ªëi</h4>
        <div id="status" class="status-err">Ch∆∞a k·∫øt n·ªëi</div>
        <div id="chat-log"></div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="chatInput" placeholder="G·ª≠i chat...">
            <button onclick="sendChat()" style="background: #6c757d;">G·ª≠i</button>
        </div>
    </div>

<script>
    const WS_URL = "ws://localhost:8080/";
    let socket = null;
    const tableBody = document.querySelector("#appTable tbody");

    function connect() {
        socket = new WebSocket(WS_URL);
        
        socket.onopen = () => {
            updateStatus("ƒê√£ k·∫øt n·ªëi", true);
            sendCmd("listApps"); // T·ª± ƒë·ªông l·∫•y danh s√°ch khi k·∫øt n·ªëi
        };

        socket.onmessage = (event) => {
            const data = event.data;
            try {
                // Th·ª≠ parse xem c√≥ ph·∫£i JSON kh√¥ng
                const json = JSON.parse(data);
                
                if (Array.isArray(json)) {
                    // Tr∆∞·ªùng h·ª£p 1: L√† danh s√°ch App (M·∫£ng)
                    renderTable(json);
                    logSystem("ƒê√£ c·∫≠p nh·∫≠t danh s√°ch Apps.");
                } else if (json.trang_thai) {
                    // Tr∆∞·ªùng h·ª£p 2: L√† th√¥ng b√°o tr·∫°ng th√°i (Object)
                    alert(json.thong_bao);
                    logSystem(`[${json.trang_thai.toUpperCase()}] ${json.thong_bao}`);
                    
                    // N·∫øu th√†nh c√¥ng th√¨ reload list
                    if (json.trang_thai === 'thanh_cong') sendCmd('listApps');
                }
            } catch (e) {
                // Tr∆∞·ªùng h·ª£p 3: Kh√¥ng ph·∫£i JSON -> L√† tin nh·∫Øn chat
                logChat("Server", data);
            }
        };

        socket.onclose = () => {
            updateStatus("M·∫•t k·∫øt n·ªëi - ƒêang th·ª≠ l·∫°i...", false);
            setTimeout(connect, 3000);
        };
    }

    // --- C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN ---

    function renderTable(apps) {
    tableBody.innerHTML = "";
    document.getElementById("appCount").textContent = apps.length;

    apps.forEach(app => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${app.pid}</td>
            <td style="color:#0056b3; font-weight:500">${app.tieu_de}</td>
            <td onclick="selectApp('${app.ten}')" style="cursor:pointer; color:#dc3545">
                ${app.ten}.exe
            </td>
            <td>
                <button class="btn-stop" style="padding:4px 8px; font-size:11px" onclick="quickStop('${app.ten}')">
                    ƒê√≥ng
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

    // --- C√ÅC H√ÄM G·ª¨I L·ªÜNH ---

    function sendCmd(cmd) {
        if (socket && socket.readyState === 1) {
            socket.send(cmd);
            logSystem("G·ª≠i l·ªánh: " + cmd);
        } else alert("Ch∆∞a k·∫øt n·ªëi Server!");
    }

    function stopApp() {
        const name = document.getElementById("appName").value;
        if(name) sendCmd(`stopApp ${name}`);
        else alert("Vui l√≤ng nh·∫≠p t√™n App!");
    }
    
    function quickStop(name) {
        if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën t·∫Øt " + name + "?")) {
            sendCmd(`stopApp ${name}`);
        }
    }

    function startApp() {
        const name = document.getElementById("appName").value;
        if(name) sendCmd(`startApp ${name}`);
        else alert("Vui l√≤ng nh·∫≠p t√™n App!");
    }

    function sendChat() {
        const txt = document.getElementById("chatInput").value;
        if(txt) {
            socket.send(txt);
            logChat("Me", txt);
            document.getElementById("chatInput").value = "";
        }
    }

    // --- HELPER LOG ---
    function updateStatus(msg, isOk) {
        const el = document.getElementById("status");
        el.textContent = msg;
        el.className = isOk ? "status-ok" : "status-err";
    }

    function logChat(sender, msg) {
        const div = document.createElement("div");
        div.className = "log-line";
        div.innerHTML = `<b>${sender}:</b> ${msg}`;
        document.getElementById("chat-log").prepend(div);
    }
    
    function logSystem(msg) {
        const div = document.createElement("div");
        div.className = "log-line";
        div.style.color = "#888";
        div.innerHTML = `<i>${msg}</i>`;
        document.getElementById("chat-log").prepend(div);
    }

    window.onload = connect;
</script>

</body>
</html>