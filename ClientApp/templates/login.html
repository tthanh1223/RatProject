<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAT - Connection</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/login.css">
</head>
<body>
    <div class="login-container">
        <div class="logo">üì° REMOTE CONTROLLER</div>
        <div class="subtitle">CONNECTION SETUP</div>

        <form id="loginForm">
            <div class="form-group">
                <label for="serverAddress">SERVER ADDRESS</label>
                <input 
                    type="text" 
                    id="serverAddress" 
                    placeholder="192.168.1.100:8080"
                    pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]{1,5}$"
                    required
                >
                <div class="helper-text">Format: IP:PORT (v√≠ d·ª•: 192.168.1.50:8080)</div>
            </div>

            <button type="submit" class="btn btn-primary" id="btnConnect">
                ‚ñ∂ CONNECT TO SERVER
            </button>

            <div class="divider"></div>

            <button type="button" class="btn btn-secondary" id="btnDiscover">
                üîç AUTO DISCOVER
            </button>

            <div class="discovered-servers" id="discoveredServers"></div>
        </form>

        <div class="status" id="status"></div>
    </div>

    <script>
        const form = document.getElementById('loginForm');
        const input = document.getElementById('serverAddress');
        const btnConnect = document.getElementById('btnConnect');
        const btnDiscover = document.getElementById('btnDiscover');
        const status = document.getElementById('status');
        const discoveredList = document.getElementById('discoveredServers');

        // ===== VALIDATE IP:PORT =====
        function validateAddress(address) {
            const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?):([0-9]{1,5})$/;
            const match = address.match(regex);
            if (!match) return null;
            
            const port = parseInt(match[1]);
            if (port < 1 || port > 65535) return null;
            
            return address;
        }

        // ===== HI·ªÇN TH·ªä STATUS =====
        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }

        // ===== TH·ª¨ K·∫æT N·ªêI WEBSOCKET =====
        async function testConnection(address) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`ws://${address}/`);
                let isHandshakeReceived = false;
                
                const timeout = setTimeout(() => {
                    if (!isHandshakeReceived) {
                        ws.close();
                        reject(new Error('Timeout: Server kh√¥ng ph·∫£n h·ªìi'));
                    }
                }, 5000);

                ws.onopen = () => {
                    showStatus('ƒêang ch·ªù x√°c th·ª±c t·ª´ server...', 'info');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Ki·ªÉm tra handshake t·ª´ server
                        if (data.type === 'handshake' && data.server_name === 'RAT_SERVER_V1.0') {
                            clearTimeout(timeout);
                            isHandshakeReceived = true;
                            ws.close();
                            resolve(true);
                        }
                    } catch (e) {
                        // Kh√¥ng ph·∫£i JSON ho·∫∑c kh√¥ng ƒë√∫ng format
                    }
                };

                ws.onerror = (error) => {
                    clearTimeout(timeout);
                    ws.close();
                    reject(new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server'));
                };

                ws.onclose = () => {
                    clearTimeout(timeout);
                    if (!isHandshakeReceived) {
                        reject(new Error('Server ƒë√≥ng k·∫øt n·ªëi kh√¥ng mong mu·ªën'));
                    }
                };
            });
        }

        // ===== X·ª¨ L√ù FORM SUBMIT =====
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const address = input.value.trim();
            
            if (!validateAddress(address)) {
                showStatus('‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá! Format: IP:PORT', 'error');
                return;
            }

            btnConnect.disabled = true;
            btnConnect.textContent = '‚è≥ CONNECTING...';
            showStatus('ƒêang k·∫øt n·ªëi t·ªõi ' + address + '...', 'info');

            try {
                await testConnection(address);
                showStatus('‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!', 'success');
                
                // Chuy·ªÉn sang dashboard sau 1 gi√¢y
                setTimeout(() => {
                    window.location.href = `/?server=${address.split(':')[0]}`;
                }, 1000);
                
            } catch (error) {
                showStatus('‚ùå ' + error.message, 'error');
                btnConnect.disabled = false;
                btnConnect.textContent = '‚ñ∂ CONNECT TO SERVER';
            }
        });

        // ===== AUTO DISCOVER (Simplified) =====
        btnDiscover.addEventListener('click', async () => {
            showStatus('üîç ƒêang qu√©t m·∫°ng LAN...', 'info');
            btnDiscover.disabled = true;
            btnDiscover.textContent = '‚è≥ SCANNING...';
            discoveredList.innerHTML = '';
            discoveredList.style.display = 'none';

            // L·∫•y IP c·ªßa m√°y hi·ªán t·∫°i
            const localIP = await fetch('/api/get-local-ip').then(r => r.text());
            const subnet = localIP.substring(0, localIP.lastIndexOf('.'));
            
            const commonPorts = [8080, 8081, 9000];
            const found = [];

            // Qu√©t 20 IP g·∫ßn nh·∫•t (gi·∫£m th·ªùi gian)
            const startIP = parseInt(localIP.split('.')[3]) - 10;
            const endIP = startIP + 20;

            for (let i = Math.max(1, startIP); i <= Math.min(254, endIP); i++) {
                for (const port of commonPorts) {
                    try {
                        const testAddr = `${subnet}.${i}:${port}`;
                        await testConnection(testAddr);
                        found.push(testAddr);
                        
                        // Hi·ªÉn th·ªã ngay khi t√¨m th·∫•y
                        const item = document.createElement('div');
                        item.className = 'server-item';
                        item.textContent = `‚úì ${testAddr}`;
                        item.onclick = () => {
                            input.value = testAddr;
                            form.dispatchEvent(new Event('submit'));
                        };
                        discoveredList.appendChild(item);
                        discoveredList.style.display = 'block';
                    } catch (e) {
                        // Server kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng ph·∫£i RAT server
                    }
                }
            }

            btnDiscover.disabled = false;
            btnDiscover.textContent = 'üîç AUTO DISCOVER';

            if (found.length === 0) {
                showStatus('‚ùå Kh√¥ng t√¨m th·∫•y server n√†o trong m·∫°ng', 'error');
            } else {
                showStatus(`‚úÖ T√¨m th·∫•y ${found.length} server(s)`, 'success');
            }
        });

        // Focus input khi load trang
        input.focus();
    </script>
</body>
</html>